**目录：**

- [1. 介绍](#1-介绍)
- [2. HTTP/2 协议概览](#2-http2-协议概览)
  - [2.1. 本规范的结构](#21-本规范的结构)
  - [2.2. 惯例和术语](#22-惯例和术语)
- [3. 启动HTTP/2](#3-启动http2)
  - [3.1. HTTP/2 版本标识符](#31-http2-版本标识符)
    - [3.1.1. 为 "http" URI 启动HTTP/2](#311-为-http-uri-启动http2)
    - [3.1.2. HTTP2-Settings 首部字段](#312-http2-settings-首部字段)

# 1. 介绍

超文本传输协议（HTTP）是一个非常成功的协议。然而，HTTP/1.1 使用底层传输的方式（[RFC7230]，第 6 节）有几个特点，对今天的应用性能有负面的整体影响。

特别是，HTTP/1.0 允许在一个给定的 TCP 连接上一次只有一个请求是未完成的。HTTP/1.1 增加了请求流水线，但这只是部分地解决了请求的并发性，而且仍然存在报头阻塞的问题。因此，需要发出许多请求的 HTTP/1.0 和 HTTP/1.1 客户使用与服务器的多个连接，以实现并发性，从而减少延时。此外，HTTP 首部字段往往是重复的和冗长的，造成不必要的网络流量，以及导致最初的 TCP[TCP]拥塞窗口迅速充满。当在一个新的 TCP 连接上发出多个请求时，这可能会导致过度的延时。

HTTP/2 通过定义 HTTP 语义与底层连接的优化映射来解决这些问题。具体来说，它允许在同一连接上交错发送请求和响应信息，并对 HTTP 首部字段使用有效的编码。它还允许对请求进行优先排序，让更重要的请求更快地完成，进一步提高性能。

由此产生的协议对网络更加友好，因为与HTTP/1.x相比，可以使用更少的TCP连接。这意味着与其他流量的竞争更少，连接时间更长，这反过来又导致了对可用网络容量的更好利用。

最后，HTTP/2还通过使用二进制报文分帧，使报文的处理更加有效。

# 2. HTTP/2 协议概览

HTTP/2为HTTP语义提供了一个优化的传输。HTTP/2支持HTTP/1.1的所有核心功能，但其目的是在几个方面更有效率。

HTTP/2的基本协议单元是一个帧（第4.1节）。每个帧类型都有不同的用途。例如，HEADERS和DATA帧是HTTP请求和响应的基础（第8.1节）；其他帧类型，如SETTINGS、WINDOW_UPDATE和PUSH_PROMISE，则用于支持HTTP/2的其他功能。

请求的复用是通过让每个HTTP请求/响应交换与它自己的流相关联来实现的（第5节）。流在很大程度上是相互独立的，所以一个被阻塞或停滞的请求或响应并不妨碍其他流的进展。

流控制和优先级确保有可能有效地使用复用流。流量控制（第5.2节）有助于确保只有接收器可以使用的数据被传输。优先级（第5.3节）确保有限的资源可以首先被引导到最重要的流。

HTTP/2增加了一种新的交互模式，即服务器可以向客户推送响应（第8.2节）。服务器推送允许服务器投机性地向客户发送服务器预计将需要的数据，用一些网络使用量来交换潜在的延迟收益。服务器通过合成一个请求来做到这一点，并将其作为一个PUSH_PROMISE帧发送。然后，服务器能够在一个单独的流中发送对合成请求的响应。

由于连接中使用的HTTP首部字段可能包含大量的冗余数据，包含它们的帧被压缩（第4.3节）。这对普通情况下的请求大小有特别有利的影响，允许许多请求被压缩到一个分组中。

## 2.1. 本规范的结构

HTTP/2规范分为四个部分。

- 启动HTTP/2（第3节）涉及如何初始化HTTP/2连接。
- 帧层（第4节）和流层（第5节）描述了HTTP/2帧的结构和形成复用流的方式。
- 帧（第6节）和错误（第7节）的定义包括HTTP/2中使用的帧和错误类型的细节。
- HTTP映射（第8节）和附加要求（第9节）描述了如何使用帧和流来表达HTTP语义。

虽然一些帧层和流层的概念是从HTTP中分离出来的，但本规范并没有定义一个完全通用的帧层。帧层和流层是根据HTTP协议和服务器推送的需要而定制的。

## 2.2. 惯例和术语

本文档中的关键词 “必须”、“不得”、“需要”、“应当”、“不应当”、“应该”、“不应该”、“推荐”、“可以” 和 “可选” 应按照[RFC 2119]中的描述进行解释。

所有的数字值都是按网络字节顺序排列的。除非另有说明，否则数值是无符号的。字面值根据情况以十进制或十六进制提供。十六进制的字头以 "0x" 为前缀，以区别于十进制的字头。

使用了以下术语：

- **客户(client)**。发起HTTP/2连接的端点。客户发送HTTP请求并接收HTTP响应。
- **连接(connection)**。两个端点之间的传输层连接。
- **连接错误(connection error)**。一个影响整个HTTP/2连接的错误。
- **端点(endpoint)**。连接的客户或服务器。
- **帧(frame)**。HTTP/2连接中最小的通信单位，由一个首部和一个根据帧类型结构的可变长度的八位字节序列组成。
- **对等方(peer)**。一个端点。当讨论一个特定的端点时，"对等方" 指的是与主要讨论对象相距遥远的端点。
- **接收方(receiver)**。一个正在接收帧的端点。
- **发送方(sender)**。一个正在传输帧的端点。
- **服务器(server)**。接受HTTP/2连接的端点。服务器接收HTTP请求并发送HTTP响应。
- **流(stream)**。HTTP/2连接内的帧的双向流动。
- **流错误(stream error)**。单个HTTP/2流上的错误。

最后，术语 "网关"、"中介"、"代理" 和 "隧道" 在[RFC7230]的第2.3节中被定义。中介在不同时间既是客户又是服务器。

术语 "有效载荷体" 在[RFC7230]的第3.3节中定义。

# 3. 启动HTTP/2

HTTP/2连接是一个运行在TCP连接之上的应用层协议（[TCP]）。客户是TCP连接的发起者。

HTTP/2使用HTTP/1.1使用的相同的 "http" 和 "https" URI方案。HTTP/2共享相同的默认端口号。80用于 "http" URIs，443用于 "https" URIs。因此，处理 "http://example.org/foo" 或 "https://example.com/bar" 等目标资源URI的请求的实现，需要首先发现上游服务器（客户希望建立连接的直接对等方）是否支持HTTP/2。

对于 "http" 和 "https" URI，确定支持HTTP/2的方法是不同的。对 "http" URI的发现将在第3.2节中描述。对 "https" URI的发现将在第3.3节中描述。

## 3.1. HTTP/2 版本标识符

本文档中定义的协议有两个标识符。

- 字符串 "h2" 标识了HTTP/2使用传输层安全（TLS）[TLS12]的协议。这个标识符用于TLS应用层协议协商（ALPN）扩展[TLS-ALPN]字段以及任何标识使用 TLS 的HTTP/2 的地方。

"h2" 字符串被序列化为ALPN协议标识符的两个八位数序列。0x68, 0x32。

- 字符串 "h2c" 标识了HTTP/2通过明文TCP运行的协议。这个标识符被用于HTTP/1.1 Upgrade首部字段和任何标识使用 TCP 的 HTTP/2 的地方。

"h2c" 字符串是从ALPN标识符空间中保留的，但描述了不使用TLS的协议。

协商 "h2" 或 "h2c" 意味着使用本文当中描述的传输、安全、分帧和报文语义。

### 3.1.1. 为 "http" URI 启动HTTP/2

在事先不知道下一跳是否支持HTTP/2的情况下，对 "http" URI提出请求的客户使用HTTP升级机制（[RFC7230]第6.7节）。客户通过发出HTTP/1.1请求，其中包括一个带有 "h2c" 标记的Upgrade首部字段。这样的HTTP/1.1请求 **必须** 正好包括一个HTTP2-Settings（第3.2.1节）首部字段。

例如:

```http
GET / HTTP/1.1
Host: server.example.com
Connection: Upgrade, HTTP2-Settings
Upgrade: h2c
HTTP2-Settings: <base64url encoding of HTTP/2 SETTINGS payload>
```

包含有效载荷体的请求 **必须** 在客户发送HTTP/2帧之前全部发送完毕。这意味着一个大的请求可能会阻塞连接的使用，直到它被完全发送。

如果初始请求与后续请求的并发性很重要，可以使用OPTIONS请求来执行升级到HTTP/2，但需要付出额外的往返费用。

不支持HTTP/2的服务器可以对请求作出响应，就像没有Upgrade首部字段一样：

```http
HTTP/1.1 200 OK
Content-Length: 243
Content-Type: text/html
...
```

服务器 **必须** 忽略Upgrade 首部字段 中的 "h2" 标记。带有 "h2" 的标记的存在意味着HTTP/2使用TLS，而这是如第3.3节所述的协商。

支持HTTP/2的服务器以101(Switching Protocols)的响应接受升级。在结束101响应的空行之后，服务器可以开始发送HTTP/2帧。这些帧 **必须** 包括对启动升级的请求的响应。

```http
For example:
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: h2c
[ HTTP/2 connection ...
```

服务器发送的第一个HTTP/2帧 **必须** 是服务器连接前言（第3.5节），包括一个SETTINGS帧（第6.5节）。收到101响应后，客户 **必须** 发送一个连接前言（第3.5节），其中包括一个SETTINGS帧。

在升级之前发送的HTTP/1.1请求被分配了一个流标识符为1（见第5.1.1节），具有默认的优先级值（第5.3.5节）。流1从客户向服务器隐含地 "半关闭"（见第5.1节），因为该请求是作为HTTP/1.1请求完成的。在开始HTTP/2连接后，流1被用于响应。

### 3.1.2. HTTP2-Settings 首部字段

从HTTP/1.1升级到HTTP/2的请求 **必须** 包括一个 "HTTP2-Settings" 首部字段。HTTP2-Settings首部字段是一个特定于连接的首部字段，包括管理HTTP/2连接的参数，在服务器接受升级请求时提供。

```
HTTP2-Settings = token68
 

如果这个首部字段不存在或存在多个首部字段，则服务器 **不得** 将连接升级到HTTP/2。服务器 **不得** 发送这个首部字段。

HTTP2-Settings首部字段的内容是SETTINGS帧（第6.5节）的有效载荷，编码为base64url字符串（即[RFC4648]第5节中描述的URL-和文件名安全的Base64编码，省略任何尾部的'='字符）。用于 "token68 "的ABNF[RFC5234]生产在[RFC7235]的第2.1节中定义。

由于升级只适用于即时连接，发送HTTP2-Settings首部字段的客户端必须同时发送 "HTTP2-Settings "作为Connection首部字段的连接选项，以防止其被转发（见[RFC7230]第6.1节）。

服务器对这些值进行解码和解释，就像它对其他SETTINGS帧一样。对这些设置的明确确认（第6.5.3节）是不必要的，因为101响应可以作为隐式确认。在升级请求中提供这些值使客户有机会在收到服务器的任何帧之前提供参数。

